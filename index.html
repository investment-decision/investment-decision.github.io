<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Regime Dashboard</title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. 기본 설정 --- */
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #65676b;
            --accent-growth: #007aff;
            --accent-inflation: #ff3b30;
            --accent-liquidity: #af52de;
            --accent-sentiment: #ff9500;
            --accent-leading: #34c759;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: var(--text-primary);
        }

        h1, h2, h3 { margin: 0; }
        
        .container {
            max-width: 1600px; /* 넓은 화면 활용 */
            margin: 0 auto;
        }

        .header {
            margin-bottom: 20px;
            padding: 0 10px;
        }
        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* --- 2. 그리드 레이아웃 (4 Columns) --- */
        .dashboard-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            padding-left: 10px;
            font-weight: 600;
            border-left: 4px solid #333;
            line-height: 1.2;
        }

        /* --- 3. 카드 스타일 --- */
        .chart-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: relative;
            display: flex;
            flex-direction: column;
            min-height: 300px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .chart-title {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .chart-subtitle {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* 정보 버튼 (?) */
        .info-btn {
            background: #f0f2f5;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            color: var(--text-secondary);
            font-weight: bold;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .info-btn:hover {
            background: #e4e6eb;
            color: var(--text-primary);
        }

        .chart-area {
            flex-grow: 1;
            position: relative;
            min-height: 200px;
        }

        /* 플레이스홀더 (데이터 없음) */
        .no-data {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #ccc;
            font-size: 0.9rem;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px dashed #ddd;
        }

        /* --- 4. 팝업 모달 --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .modal-body {
            font-size: 0.95rem;
            line-height: 1.6;
            color: #444;
        }
        .modal-body ul { padding-left: 20px; margin: 10px 0; }
        .modal-body li { margin-bottom: 5px; }

        /* --- 반응형 --- */
        @media (max-width: 1200px) {
            .dashboard-row { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .dashboard-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>Market Regime Dashboard</h1>
        </div>

        <!-- ROW 1: Main Indices -->
        <div class="section-title">Row 1: Main Market Indices</div>
        <div class="dashboard-row">
            
            <!-- 1-1. Macro Regime -->
            <div class="chart-card">
                <div class="card-header">
                    <div>
                        <div class="chart-title">Macro Regime Composite</div>
                        <div class="chart-subtitle">Growth vs Inflation (Quadrant)</div>
                    </div>
                    <button class="info-btn" onclick="openModal('macro')">?</button>
                </div>
                <div class="chart-area">
                    <canvas id="chartMacro"></canvas>
                </div>
            </div>

            <!-- 1-2. Global Net Liquidity -->
            <div class="chart-card">
                <div class="card-header">
                    <div>
                        <div class="chart-title">Global Net Liquidity Gauge</div>
                        <div class="chart-subtitle">Fed Assets - TGA - RRP</div>
                    </div>
                    <button class="info-btn" onclick="openModal('liquidity')">?</button>
                </div>
                <div class="chart-area">
                    <canvas id="chartLiquidity"></canvas>
                </div>
            </div>

            <!-- 1-3. Composite Sentiment -->
            <div class="chart-card">
                <div class="card-header">
                    <div>
                        <div class="chart-title">Composite Sentiment Oscillator</div>
                        <div class="chart-subtitle">Fear vs Greed</div>
                    </div>
                    <button class="info-btn" onclick="openModal('sentiment')">?</button>
                </div>
                <div class="chart-area">
                    <div class="no-data">Data Not Available<br>(Requires Backend Update)</div>
                </div>
            </div>

            <!-- 1-4. Inter-Market Leading -->
            <div class="chart-card">
                <div class="card-header">
                    <div>
                        <div class="chart-title">Inter-Market Leading Indicator</div>
                        <div class="chart-subtitle">Copper/Gold, Yield Curve</div>
                    </div>
                    <button class="info-btn" onclick="openModal('leading')">?</button>
                </div>
                <div class="chart-area">
                    <div class="no-data">Data Not Available<br>(Requires Backend Update)</div>
                </div>
            </div>
        </div>

        <!-- ROW 2: Components (Z-Scores) -->
        <div class="section-title">Row 2: Component Drivers (Time Series)</div>
        <div class="dashboard-row">
            
            <!-- 2-1. Z_PMI -->
            <div class="chart-card">
                <div class="card-header">
                    <div>
                        <div class="chart-title">Z_PMI (Manufacturing)</div>
                        <div class="chart-subtitle">Growth Driver</div>
                    </div>
                    <button class="info-btn" onclick="openModal('pmi')">?</button>
                </div>
                <div class="chart-area">
                    <canvas id="chartPmi"></canvas>
                </div>
            </div>

            <!-- 2-2. Z_Ratio -->
            <div class="chart-card">
                <div class="card-header">
                    <div>
                        <div class="chart-title">Z_Ratio (Cyc/Def)</div>
                        <div class="chart-subtitle">Market Sentiment Driver</div>
                    </div>
                    <button class="info-btn" onclick="openModal('ratio')">?</button>
                </div>
                <div class="chart-area">
                    <canvas id="chartRatio"></canvas>
                </div>
            </div>

            <!-- 2-3. Z_T5YIFR -->
            <div class="chart-card">
                <div class="card-header">
                    <div>
                        <div class="chart-title">Z_T5YIFR (Inflation Exp)</div>
                        <div class="chart-subtitle">Inflation Driver</div>
                    </div>
                    <button class="info-btn" onclick="openModal('t5yifr')">?</button>
                </div>
                <div class="chart-area">
                    <canvas id="chartT5yifr"></canvas>
                </div>
            </div>

            <!-- 2-4. Z_Commodity -->
            <div class="chart-card">
                <div class="card-header">
                    <div>
                        <div class="chart-title">Z_Commodity</div>
                        <div class="chart-subtitle">Inflation Driver</div>
                    </div>
                    <button class="info-btn" onclick="openModal('commodity')">?</button>
                </div>
                <div class="chart-area">
                    <canvas id="chartCommodity"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Template -->
    <div id="infoModal" class="modal-overlay" onclick="if(event.target === this) closeModal()">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <div id="modalTitle" class="modal-title"></div>
            <div id="modalBody" class="modal-body"></div>
        </div>
    </div>

    <script>
        // --- Modal Content Database ---
        const MODAL_DATA = {
            macro: {
                title: "거시경제 국면 지수 (Macro Regime)",
                body: `
                    <p>경제 성장(Growth)과 물가(Inflation) 두 축을 기준으로 현재 경제 사계절을 진단합니다.</p>
                    <ul>
                        <li><strong>Reflation (회복):</strong> 성장↑ 물가↓ (주식 비중 확대)</li>
                        <li><strong>Overheat (과열):</strong> 성장↑ 물가↑ (원자재/가치주)</li>
                        <li><strong>Stagflation (스태그):</strong> 성장↓ 물가↑ (현금/금)</li>
                        <li><strong>Deflation (수축):</strong> 성장↓ 물가↓ (채권/달러)</li>
                    </ul>`
            },
            liquidity: {
                title: "글로벌 순유동성 지수 (Net Liquidity)",
                body: `
                    <p>연준(Fed)의 총자산에서 실제 시장에 풀리지 않은 자금을 뺀 '실질 유동성'입니다.</p>
                    <p><strong>공식:</strong> Fed Assets - TGA - RRP</p>
                    <ul>
                        <li>상승 시: 위험자산(주식, 코인) 선호 심리 강화</li>
                        <li>하락 시: 유동성 축소로 인한 조정 가능성</li>
                    </ul>`
            },
            sentiment: {
                title: "복합 심리 오실레이터 (Sentiment)",
                body: `<p>시장 참여자들의 공포와 탐욕을 측정합니다.</p>
                       <ul><li>VIX, 풋/콜 비율, 정크본드 스프레드 등을 종합</li><li>극단적 공포(저점)와 탐욕(고점)을 식별하여 역발상 투자에 활용</li></ul>`
            },
            leading: {
                title: "시장 간 선행 지수 (Leading Indicator)",
                body: `<p>채권과 원자재 시장의 스마트 머니 흐름을 통해 주식 시장의 방향을 선행 예측합니다.</p>
                       <ul><li>구리/금 비율, 장단기 금리차 등 활용</li></ul>`
            },
            pmi: {
                title: "Z_PMI (ISM Manufacturing)",
                body: `<p>실물 경기의 대표적 선행 지수입니다. 신규 주문(New Orders)은 주가 사이클을 선행합니다.</p>`
            },
            ratio: {
                title: "Z_Ratio (Cyclical vs Defensive)",
                body: `<p>경기민감주와 방어주의 상대 성과입니다. 시장 참여자들이 전망하는 실시간 경제 성장을 반영합니다.</p>`
            },
            t5yifr: {
                title: "Z_T5YIFR (5Y Inflation Exp)",
                body: `<p>시장이 예상하는 5년 뒤의 기대 인플레이션입니다. 단기 유가 등 노이즈를 제거한 구조적 물가 뷰입니다.</p>`
            },
            commodity: {
                title: "Z_Commodity (Broad Index)",
                body: `<p>원자재(에너지, 금속, 농산물) 가격 지수입니다. 소비자물가(CPI)를 선행하는 물가 압력 지표입니다.</p>`
            }
        };

        function openModal(key) {
            const data = MODAL_DATA[key];
            if(data) {
                document.getElementById('modalTitle').innerHTML = data.title;
                document.getElementById('modalBody').innerHTML = data.body;
                document.getElementById('infoModal').style.display = 'flex';
            }
        }

        function closeModal() {
            document.getElementById('infoModal').style.display = 'none';
        }

        // --- Chart Logic ---
        async function createCharts() {
            try {
                const response = await fetch('./data/market_indices.json');
                if (!response.ok) throw new Error("Network response was not ok");
                const text = await response.text();
                if (!text) return; // Empty file check

                const rawData = JSON.parse(text);
                const labels = rawData.map(d => d.date);
                
                // Common Chart Options
                const commonOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { display: false } },
                    scales: { 
                        x: { display: false }, // 깔끔하게 X축 숨김 (툴팁으로 확인)
                        y: { grid: { color: '#f0f0f0' } }
                    },
                    elements: { point: { radius: 0, hoverRadius: 4 } }
                };

                // 1. Macro Regime (Scatter)
                const trailLength = 60;
                const recentData = rawData.slice(-trailLength);
                const scatterData = recentData.map(d => ({ x: d.growth_index, y: d.inflation_index }));
                
                new Chart(document.getElementById('chartMacro'), {
                    type: 'scatter',
                    data: {
                        datasets: [
                            {
                                data: scatterData.slice(0, -1),
                                backgroundColor: 'rgba(200, 200, 200, 0.5)',
                                pointRadius: 2
                            },
                            {
                                data: [scatterData[scatterData.length - 1]],
                                backgroundColor: '#e74c3c',
                                pointRadius: 6
                            }
                        ]
                    },
                    options: {
                        ...commonOptions,
                        scales: {
                            x: { grid: { color: (ctx) => ctx.tick.value === 0 ? '#333' : '#eee' } },
                            y: { grid: { color: (ctx) => ctx.tick.value === 0 ? '#333' : '#eee' } }
                        }
                    }
                });

                // 2. Liquidity (Line)
                new Chart(document.getElementById('chartLiquidity'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{ 
                            data: rawData.map(d => d.liquidity_index), // Using index if avail
                            borderColor: '#af52de', borderWidth: 2, fill: false, tension: 0.3 
                        }]
                    },
                    options: commonOptions
                });

                // 3 & 4: No Data (Skip)

                // Row 2 Components
                const createComponentChart = (id, dataKey, color) => {
                    new Chart(document.getElementById(id), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{ 
                                data: rawData.map(d => d[dataKey]), 
                                borderColor: color, borderWidth: 1.5, fill: false, tension: 0.1 
                            }]
                        },
                        options: commonOptions
                    });
                };

                createComponentChart('chartPmi', 'z_pmi', '#007aff');
                createComponentChart('chartRatio', 'z_ratio', '#007aff');
                createComponentChart('chartT5yifr', 'z_t5yifr', '#ff3b30');
                createComponentChart('chartCommodity', 'z_commodity', '#ff3b30');

            } catch (error) {
                console.error("Error:", error);
            }
        }

        createCharts();
    </script>
</body>
</html>